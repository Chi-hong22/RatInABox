# GridCell 三余弦叠加算法详解

## 📐 核心数学模型

Grid cell 的六边形网格模式由**三个互成 60° 的余弦波叠加**形成：

```
r(x) = (1/3) * [cos(φ₁) + cos(φ₂) + cos(φ₃)]
```

其中相位计算：

```
φᵢ = 2π/λ * [(x - x₀) · wᵢ]
```

### 参数说明

| 符号 | 含义 | 作用 |
|------|------|------|
| `λ` | gridscale（网格尺度） | 控制网格密度：λ 越大，网格越稀疏 |
| `x₀` | origin（网格原点） | 控制网格平移：x₀ = λ·φ₀/(2π) |
| `φ₀` | phase_offset（相位偏移） | 决定网格在空间中的位置 |
| `wᵢ` | 方向向量 | 三个互成 60° 的单位向量 |
| `x` | 当前位置 | Agent 在环境中的坐标 |

---

## 🔄 计算步骤（对应代码）

### 步骤 0: 初始化方向向量（构造函数）

```matlab
% 基准方向
w₁ = [cos(θ), sin(θ)]

% 旋转 60° 和 120°
w₂ = rotate_vec(w₁, π/3)    % 逆时针 60°
w₃ = rotate_vec(w₁, 2π/3)   % 逆时针 120°
```

**几何关系：**
```
        w₂ (120°)
         ↑  ╱
         │ ╱ 60°
         │╱
    ─────┼─────→ w₁ (0°)
         │
         │ 60°
         ↓
        w₃ (240°)
```

**代码位置：** `GridCells.m` 第 98-130 行

---

### 步骤 1: 计算网格原点

```matlab
origin = λ * φ₀ / (2π)
```

- 每个 grid cell 有自己的 `origin`（由 `phase_offset` 决定）
- `origin` 决定网格在空间中的"锚点"

**代码位置：** `GridCells.m` 第 179 行

---

### 步骤 2: 计算位置向量

```matlab
vec = origin - pos
```

- 从当前位置 `pos` 指向 `origin` 的向量
- 对应 Python 版本的 `utils.get_vectors_between(origin, pos)`

**代码位置：** `GridCells.m` 第 182-187 行

---

### 步骤 3: 计算三个方向的相位

```matlab
φ₁ = (2π/λ) * (vec · w₁)
φ₂ = (2π/λ) * (vec · w₂)
φ₃ = (2π/λ) * (vec · w₃)
```

- `vec · wᵢ` 是**点积**，计算 `vec` 在 `wᵢ` 方向上的投影
- `2π/λ` 将物理距离转换为相位（角度）

**代码位置：** `GridCells.m` 第 189-211 行

---

### 步骤 4: 三余弦波叠加

#### 4.1 整流余弦模式（`rectified_cosines`）

```matlab
r(x) = (1/3) * [cos(φ₁) + cos(φ₂) + cos(φ₃)]

% 归一化
r_normalized = (r - r_min) / (1 - r_min)

% 整流（截断负值）
r_final = max(0, r_normalized)
```

- **特点：** 峰值尖锐，谷底为 0（无发放）
- **应用：** 更符合生物学实际（神经元发放率≥0）

#### 4.2 平移余弦模式（`shifted_cosines`）

```matlab
r(x) = (2/3) * [(1/3)(cos(φ₁) + cos(φ₂) + cos(φ₃)) + 0.5]
```

- **特点：** 峰值平滑，谷底有基础发放率
- **应用：** 数学上更平滑，便于理论分析

**代码位置：** `GridCells.m` 第 214-242 行

---

## 🔺 六边形网格的形成原理

### 为什么是六边形？

当三个方向的相位**同时接近 0**（或 `2πk`）时：

```
cos(φ₁) ≈ 1
cos(φ₂) ≈ 1
cos(φ₃) ≈ 1

→ r(x) = (1/3) * (1 + 1 + 1) = 1  （最大发放率）
```

这些峰值点在空间中的分布由三个方向决定：

```
设峰值条件：φᵢ = 2πkᵢ  (kᵢ ∈ ℤ)

即：(x - x₀) · wᵢ = kᵢλ

这三个线性方程的交点形成三角形格子，
其对偶结构正是六边形点阵！
```

### 几何直观

```
     ●───●───●───●
    ╱ ╲ ╱ ╲ ╱ ╲ ╱ ╲
   ●───●───●───●───●
    ╲ ╱ ╲ ╱ ╲ ╱ ╲ ╱
     ●───●───●───●
    ╱ ╲ ╱ ╲ ╱ ╲ ╱ ╲
   ●───●───●───●───●

   ● = 发放峰值点（三个相位同时为 0）
```

- 六边形的**边长** ≈ `λ`（gridscale）
- 六边形的**方向**由 `orientation` 决定
- 六边形的**位置**由 `phase_offset` 决定

---

## 📊 参数效果对比

### 1. gridscale 的影响

```
λ = 0.2m  →  ●●●●●●  （密集网格）
λ = 0.4m  →  ● ● ●   （中等网格）
λ = 0.8m  →  ●   ●   （稀疏网格）
```

### 2. orientation 的影响

```
θ = 0°    →  ⬡  （标准朝向）
θ = 30°   →  ⬢  （旋转 30°）
```

### 3. phase_offset 的影响

```
φ₀ = [0, 0]      →  原点处有峰值
φ₀ = [π, π]      →  原点处在谷底
φ₀ = [random]    →  随机平移
```

### 4. description 的影响

```matlab
rectified_cosines  →  ◆ (尖锐峰，黑色背景)
shifted_cosines    →  ◇ (平滑峰，灰色背景)
```

---

## 🎯 代码结构总结

| 阶段 | 位置 | 功能 |
|------|------|------|
| **初始化** | 构造函数 (98-130行) | 计算 w₁, w₂, w₃ 方向向量 |
| **步骤1** | get_state (179行) | 计算 origin |
| **步骤2** | get_state (182-187行) | 计算 vec = origin - pos |
| **步骤3** | get_state (189-211行) | 计算 φ₁, φ₂, φ₃ |
| **步骤4** | get_state (214-242行) | 三余弦叠加 + 归一化 |

---

## 🔬 验证方法

运行以下命令查看不同参数的效果：

```matlab
close all; clear; clc;
demo_gridcells_visual
```

**预期输出：**
- **Figure 1:** 三个模块的网格密度对比（gridscale 效果）
- **Figure 2:** 单个细胞的详细六边形点阵
- **Figure 3:** rectified_cosines vs shifted_cosines 对比

---

## 📚 参考文献

1. Hafting et al. (2005). *Microstructure of a spatial map in the entorhinal cortex.* Nature.
2. Rowland et al. (2016). *Ten Years of Grid Cells.* Annual Review of Neuroscience.

---

## 💡 常见问题

### Q1: 为什么是三个余弦波，不是两个或四个？

**A:** 两个余弦波只能形成条纹（stripe pattern），无法形成二维周期结构。三个方向是形成**周期性平面密铺**的最小数量（对应三角形/六边形格子）。四个及以上会过度约束。

### Q2: width_ratio 参数的作用？

**A:** 控制六边形"点"的大小。`width_ratio` 越小，峰值越尖锐（接近脉冲）；越大，峰值越宽（接近平台）。

### Q3: 如何模拟多尺度编码？

**A:** 使用 `modules` 分布：

```matlab
params = struct(...
    'gridscale', [0.2, 0.4, 0.8], ...           % 三个尺度
    'gridscale_distribution', 'modules', ...    % 模块分布
    'n', 30);                                    % 30 个细胞均分到三个模块
```

---

**文件更新日期：** 2026-01-14  
**对应代码版本：** matlab/GridCells.m (287 lines)
